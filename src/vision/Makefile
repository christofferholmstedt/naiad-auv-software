##Shared-Part linked Makefile
##Version 1.01

#Root Directory
ROOT_DIRECTORY = ./

#Auto-generate directories
DIRS := ${sort ${dir ${wildcard ${ROOT_DIRECTORY}/*/${ROOT_DIRECTORY}/*/*/}}}


#OpenCV object
OCVOB = visionBindings/visionBindings

#Package List
CSC_LIST = image imagepreprocessing imageprocessing mission

#Main program
MAIN = visionHandler/src/main

#additional directory
VISIONBINDINGDIR = visionBindings/ 
MAINVISIONDIR = src/
IMAGEPROCESSINGDIR = imageprocessing/src

#additional ob
ADDOBJ1 = visionBindings/visionBindings.o

#additional ob
#ADDOBJ2 = visionBindings/visionbindings_hpp.o

#-fPIC
NEED_FPIC = -fPIC

#g++ directory
GPLUS = /usr/bin/g++-4.6

#path for gnatlib.so , through 'gnatls -v'
GLIB = /usr/gnat/lib/gcc/x86_64-pc-linux-gnu/4.7.4/adalib/

#Library directories
#Expanded from Package List
LIB_DIR = ${foreach dir,${CSC_LIST},${dir}/lib/lib${dir}.so}

${MAIN} : objects ${LIB_DIR}
	echo "Objects done"
	
	gnatbind -aO${VISIONBINDINGDIR} ${MAIN} ${CSC_LIST :%=-a0%/lib } -shared #--LINK=${GPLUS}
	echo "binding done"

	gnatlink -f ${MAIN} ${CSC_LIST :%= -l%} ${ADDOBJ1} --LINK=g++ -lstdc++ `pkg-config opencv --cflags --libs`  #${GPLUS}
	echo "linking done"

objects : 
	#recompile the sources
	gnatmake -aI${VISIONBINDINGDIR} -aO${VISIONBINDINGDIR} -aI${MAINVISIONDIR} -aO${MAINVISIONDIR} -aI${IMAGEPROCESSINGDIR} -aO${IMAGEPROCESSINGDIR} -c -d -i -m64 -gnat05 -gnato -gnatwa -fstack-check -o ${MAIN} ${MAIN}.adb ${NEED_FPIC} ${CSC_LIST :%= -I%} -largs ${OCVOB}.o -lstdc++ `pkg-config opencv --cflags --libs`


# Change here to accommodate for different components
#
${LIB_DIR} : 
	mkdir -p ${dir $@}
	cd ${dir $@} && gcc -shared -o ${notdir $} ../obj/*.o -L${GLIB}	-lgnat
	cd ${dir $@} && cp -f ../obj/*.ali .

#Dependencies for the modules
image/lib/libimageimage.so : image/obj/*.o
mission/lib/libmission.so : mission/obj/*.o
imagepreprocessing/lib/libimagepreprocessing.so : imagepreprocessing/obj/*.o
imageprocessing/lib/libimageprocessing.so : imageprocessing/obj/*.o
visionHandler/lib/libvisionHandler.so : visionHandler/obj/*.o

run ::
	LD_LIBRARY_PATH = `pwd`/image/lib:`pwd`/imagepreprocessing/lib:`pwd`/mission/lib:`pwd`/imageprocessing/lib:`pwd`/visionHandler/lib ./${MAIN} 

clean :: 
	${RM} -rf ${CSC_LIST :%=%/lib}
	${RM} ${CSC_LIST :%=%/*.ali}
	${RM} ${CSC_LIST :%=%/*.o}
	${RM} *.o *.ali ${MAIN} 
